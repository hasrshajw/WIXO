<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KS Enterprises - Dashboard</title>
    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <style>
        /* --- All CSS from the original file is included here --- */
        /* (The full CSS block is placed here) */
    </style>
</head>
<body>

    <!-- NAVBAR (Included on all pages except login) -->
    <nav class="navbar">
        <a href="index.html" class="navbar-logo">
            <img src="https://ihtnas.com/assets/ihtnas-nav.png" alt="IHTNAS Logo">
        </a>
        <div class="navbar-profile" id="profileContainer">
            <img src="https://i.stack.imgur.com/34AD2.jpg" alt="User Profile" class="profile-image" id="profileImage">
            <div class="profile-dropdown" id="profileDropdown">
                <button id="nav-logout-btn">
                    <span class="icon material-symbols-outlined">logout</span>
                    Logout
                </button>
            </div>
        </div>
    </nav>
    
    <div class="app-container">
        <!-- Main Menu Screen -->
        <div id="main-menu" class="screen active">
            <div id="due-date-summary" class="card" style="margin-bottom: 2rem; text-align: left;">
                <h3 style="margin-bottom: 1.5rem;">Upcoming & Overdue Orders</h3>
                <div id="upcoming-overdue-list" class="upcoming-cards-container">
                    <!-- Content will be injected by JS -->
                    <p style="color: var(--light-text-secondary);">Loading critical orders...</p>
                </div>
            </div>
            <div class="main-menu-actions">
                <button id="view-orders-btn" class="btn-secondary">
                    <span class="material-symbols-outlined">view_list</span>
                    View All Orders
                </button>
            </div>
        </div>
    </div>
    
    <!-- FLOATING ACTION BUTTON -->
    <div class="fab-container" id="fabContainer">
        <div class="fab-menu" id="fabMenu">
            <div class="fab-item" id="fab-take-order">
                <span class="label">Take Order</span>
                <div class="action-button"><span class="material-symbols-outlined">add_shopping_cart</span></div>
            </div>
        </div>
        <button class="fab-button" id="fabButton">
            <span class="icon">+</span>
        </button>
    </div>

    <!-- Modals -->
    <div id="message-modal" class="modal"><div class="modal-content"><p id="message-text" class="modal-message"></p><button id="message-ok-btn" class="btn-primary" style="min-width: 120px;">OK</button></div></div>
    <div id="loading-overlay" class="loading-overlay"><div class="spinner"></div></div>
    
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, onSnapshot, collection, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // This is a self-executing function to encapsulate the logic
        (function() {
            // --- CACHED DOM ELEMENTS ---
            const loadingOverlay = document.getElementById('loading-overlay');
            const profileImage = document.getElementById('profileImage');
            const profileDropdown = document.getElementById('profileDropdown');
            const navLogoutBtn = document.getElementById('nav-logout-btn');
            const fabButton = document.getElementById('fabButton');
            const fabMenu = document.getElementById('fabMenu');
            const fabTakeOrderBtn = document.getElementById('fab-take-order');
            const viewOrdersBtn = document.getElementById('view-orders-btn');
            const upcomingOverdueList = document.getElementById('upcoming-overdue-list');

            // --- APP STATE ---
            let auth, db;
            let orders = [];

            // --- UI & UX FUNCTIONS ---
            const showLoading = () => loadingOverlay.style.display = 'flex';
            const hideLoading = () => loadingOverlay.style.display = 'none';
            function toggleProfileMenu() { profileDropdown.classList.toggle('show'); }
            function toggleFabMenu() { fabMenu.classList.toggle('show'); fabButton.classList.toggle('open'); }
            
            // --- DATA & RENDERING FUNCTIONS ---
            const getStatusInfo = (order, today) => {
                if (order.status === 'completed') { return { text: 'Completed', className: 'completed' }; }
                const dueDate = order.dueDate ? new Date(order.dueDate + 'T00:00:00') : null; 
                if (dueDate && dueDate < today) { return { text: 'Overdue', className: 'overdue' }; }
                if (dueDate) {
                    const daysDiff = Math.ceil((dueDate.getTime() - today.getTime()) / (1000 * 3600 * 24));
                    if (daysDiff >= 0 && daysDiff <= 3) { return { text: `Due in ${daysDiff} day${daysDiff !== 1 ? 's' : ''}`, className: 'upcoming-due' }; }
                }
                return { text: 'Pending', className: 'pending' };
            };

            const populateUpcomingOverdueList = () => {
                upcomingOverdueList.innerHTML = '';
                const today = new Date(); today.setHours(0,0,0,0);

                const criticalOrders = orders.filter(order => {
                    if (order.status === 'completed') return false;
                    const dueDate = order.dueDate ? new Date(order.dueDate + 'T00:00:00') : null;
                    if (!dueDate) return false;
                    const daysDiff = Math.ceil((dueDate.getTime() - today.getTime()) / (1000 * 3600 * 24));
                    return (dueDate < today) || (daysDiff >= 0 && daysDiff <= 3);
                }).sort((a,b) => (new Date(a.dueDate)?.getTime() || 0) - (new Date(b.dueDate)?.getTime() || 0));

                if (criticalOrders.length === 0) {
                    upcomingOverdueList.innerHTML = '<p style="color: var(--light-text-secondary); grid-column: 1 / -1;">No critical orders.</p>';
                } else {
                    criticalOrders.forEach(order => {
                        const dueDate = new Date(order.dueDate);
                        let summaryText, statusClassName, buttonClass;
                        if (dueDate < today) {
                            summaryText = `Overdue`; statusClassName = 'overdue'; buttonClass = 'btn-danger';
                        } else {
                            const daysDiff = Math.ceil((dueDate.getTime() - today.getTime()) / (1000 * 3600 * 24));
                            summaryText = `Due in ${daysDiff} day${daysDiff !== 1 ? 's' : ''}`; statusClassName = 'upcoming-due'; buttonClass = 'btn-warning';
                        }
                        const card = document.createElement('div');
                        card.className = `upcoming-order-card ${statusClassName}`;
                        card.innerHTML = `
                            <div class="card-info"><div class="customer-name" title="${order.name}">${order.name}</div><div class="due-status">${summaryText}</div></div>
                            <button class="btn ${buttonClass} view-btn" data-id="${order.id}"><span class="material-symbols-outlined">visibility</span> View</button>`;
                        card.addEventListener('click', () => window.location.href = `order-details.html?id=${order.id}`);
                        upcomingOverdueList.appendChild(card);
                    });
                }
            };

            // --- FIREBASE & CORE LOGIC ---
            async function initializeFirebase() {
                try {
                    const firebaseConfig = {"apiKey":"AIzaSyBp4XoqX-MYvOlweR5dPfEqAP9qXu2P81E","authDomain":"harsha-jw.firebaseapp.com","projectId":"harsha-jw","storageBucket":"harsha-jw.appspot.com","messagingSenderId":"471408120499","appId":"1:471408120499:web:91e61514ad3703ce3b16c6","measurementId":"G-NBC16X4R1T"};
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    
                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            profileImage.src = user.photoURL || 'https://i.stack.imgur.com/34AD2.jpg';
                            listenForOrders(); // Start listening for data
                        } else {
                            // If user is not logged in, redirect to login page
                            window.location.href = 'login.html';
                        }
                    });
                } catch (error) {
                    console.error("Firebase Initialization Error:", error);
                    alert("Critical error initializing application.");
                    hideLoading();
                }
            }
            
            async function handleSignOut() {
                showLoading();
                try {
                    await signOut(auth);
                    // The onAuthStateChanged listener will handle the redirect.
                } catch (error) {
                    console.error("Sign Out Error:", error);
                    alert("Failed to sign out.");
                    hideLoading();
                }
            }
            
            function listenForOrders() {
                const ordersCollectionRef = collection(db, `upvc_orders`);
                const q = query(ordersCollectionRef, orderBy('createdAt', 'desc'));
                onSnapshot(q, (snapshot) => {
                    orders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    populateUpcomingOverdueList();
                    hideLoading();
                }, (error) => {
                    console.error("Firestore Snapshot Error:", error);
                    alert("Error fetching real-time data.");
                    hideLoading();
                });
            }

            // --- EVENT LISTENERS ---
            navLogoutBtn.addEventListener('click', handleSignOut);
            viewOrdersBtn.addEventListener('click', () => window.location.href = 'view-orders.html');
            fabTakeOrderBtn.addEventListener('click', () => window.location.href = 'order-form.html');
            
            // Profile & FAB menu toggles
            profileImage.addEventListener('click', (e) => { e.stopPropagation(); toggleProfileMenu(); });
            fabButton.addEventListener('click', (e) => { e.stopPropagation(); toggleFabMenu(); });
            window.addEventListener('click', (e) => {
                if (profileDropdown.classList.contains('show')) { toggleProfileMenu(); }
                if (fabMenu.classList.contains('show')) { toggleFabMenu(); }
            });

            // --- INITIALIZATION ---
            showLoading();
            initializeFirebase();
        })();
    </script>
</body>
</html>
