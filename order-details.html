<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KS Enterprises - Order Details</title>
    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <style>
        /* --- All CSS from the original file is included here --- */
        /* (The full CSS block is placed here) */
    </style>
</head>
<body>
    <!-- NAVBAR -->
    <nav class="navbar">
        <a href="index.html" class="navbar-logo">
            <img src="https://ihtnas.com/assets/ihtnas-nav.png" alt="IHTNAS Logo">
        </a>
        <div class="navbar-profile" id="profileContainer">
            <img src="https://i.stack.imgur.com/34AD2.jpg" alt="User Profile" class="profile-image" id="profileImage">
            <div class="profile-dropdown" id="profileDropdown">
                <button id="nav-logout-btn">
                    <span class="icon material-symbols-outlined">logout</span>
                    Logout
                </button>
            </div>
        </div>
    </nav>

    <div class="app-container">
        <!-- Order Details Screen -->
        <div id="order-details-screen" class="screen active">
            <div class="page-header">
                <button class="back-to-view-orders btn-secondary" onclick="window.location.href='view-orders.html'">
                    <span class="material-symbols-outlined">arrow_back</span>
                </button>
                 <h2>Order Details</h2>
            </div>
            <div class="card">
                <!-- Content is populated by JS -->
                <div style="display: flex; flex-direction: column; gap: 1rem; margin-bottom: 1.5rem;">
                    <div>
                        <p id="detail-customer-name" style="font-size: 1.5rem; font-weight: 700; color: var(--color-primary);"></p>
                        <p id="detail-customer-address" style="color: var(--light-text-secondary);"></p>
                    </div>
                    <div id="detail-status-tag" class="status-tag" style="align-self: flex-start;"></div>
                </div>
                <div id="detail-info-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 2rem;">
                    <!-- Details here -->
                </div>
                <h3 style="margin-bottom: 1rem;">Windows (<span id="detail-window-count"></span>)</h3>
                <div id="detail-windows-list"></div>
                <div class="details-action-buttons" style="display: flex; flex-wrap: wrap; justify-content: flex-end; gap: 0.75rem; margin-top: 2rem; border-top: 1px solid var(--light-border); padding-top: 2rem;">
                    <button id="detail-get-directions-btn" class="btn-secondary"><span class="material-symbols-outlined">directions</span>Get Directions</button>
                    <button id="detail-complete-btn" class="btn-success"><span class="material-symbols-outlined">check_circle</span>Mark as Complete</button>
                    <button id="detail-edit-btn" class="btn-primary"><span class="material-symbols-outlined">edit</span>Edit Order</button>
                    <button id="detail-view-quote-btn" class="btn-secondary"><span class="material-symbols-outlined">request_quote</span>View Quote</button>
                    <button id="detail-show-history-btn" class="btn-secondary"><span class="material-symbols-outlined">history</span>Show History</button>
                    <button id="detail-delete-btn" class="btn-danger"><span class="material-symbols-outlined">delete</span>Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- All required modals for this page -->
    <div id="confirmation-modal" class="modal">...</div>
    <div id="message-modal" class="modal">...</div>
    <div id="history-modal" class="modal">...</div>
    <div id="loading-overlay" class="loading-overlay"><div class="spinner"></div></div>
    <div id="price-modal" class="modal">...</div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // ... other necessary imports like getAuth, getFirestore, doc, getDoc, updateDoc, etc.

        (function() {
            // --- All JS from the original file is included here, with modifications for MPA ---
            
            // --- PAGE-SPECIFIC INITIALIZATION LOGIC ---
            let currentViewedOrderId = null;
            
            document.addEventListener('DOMContentLoaded', () => {
                const urlParams = new URLSearchParams(window.location.search);
                const orderId = urlParams.get('id');
                currentViewedOrderId = orderId;
                
                if (orderId) {
                    loadAndDisplayOrder(orderId);
                } else {
                    showMessageModal("No order specified. Redirecting...");
                    setTimeout(() => window.location.href = 'view-orders.html', 2000);
                }
            });

            async function loadAndDisplayOrder(orderId) {
                showLoading();
                try {
                    const orderRef = doc(db, 'upvc_orders', orderId);
                    const orderSnap = await getDoc(orderRef);
                    if (orderSnap.exists()) {
                        // The original showOrderDetails function is perfect for this
                        showOrderDetails({ id: orderSnap.id, ...orderSnap.data() });
                    } else {
                         showMessageModal("Order not found. Redirecting...");
                        setTimeout(() => window.location.href = 'view-orders.html', 2000);
                    }
                } catch (error) {
                    console.error("Error loading order: ", error);
                    showMessageModal("Failed to load order data.");
                } finally {
                    hideLoading();
                }
            }

            // In showOrderDetails function, modify button event listeners:
            // detailEditBtn.addEventListener('click', (e) => window.location.href = `order-form.html?id=${e.currentTarget.dataset.id}`);
            // detailViewQuoteBtn.addEventListener('click', (e) => window.location.href = `quote.html?id=${e.currentTarget.dataset.id}`);
            
            // In the delete action callback:
            // Original: showScreen(viewOrdersScreen);
            // New: window.location.href = 'view-orders.html';
        })();
    </script>
</body>
</html>
