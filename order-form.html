<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KS Enterprises - Order Form</title>
    <!-- Fonts, Icons, and Leaflet Map Library -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <style>
        /* --- All CSS from the original file is included here --- */
        /* (The full CSS block is placed here) */
    </style>
</head>
<body>

    <!-- NAVBAR -->
    <nav class="navbar">
        <a href="index.html" class="navbar-logo">
            <img src="https://ihtnas.com/assets/ihtnas-nav.png" alt="IHTNAS Logo">
        </a>
        <div class="navbar-profile" id="profileContainer">
            <img src="https://i.stack.imgur.com/34AD2.jpg" alt="User Profile" class="profile-image" id="profileImage">
            <div class="profile-dropdown" id="profileDropdown">
                <button id="nav-logout-btn">
                    <span class="icon material-symbols-outlined">logout</span>
                    Logout
                </button>
            </div>
        </div>
    </nav>
    
    <div class="app-container">
        <!-- Add/Edit Order Screen -->
        <div id="form-screen" class="screen active">
            <div class="page-header">
                 <button class="back-to-main btn-secondary" onclick="history.back()">
                    <span class="material-symbols-outlined">arrow_back</span>
                </button>
                <h2 id="form-title">Create New Order</h2>
            </div>
            <div class="card">
                <form id="order-form">
                    <input type="hidden" id="order-id">
                    <input type="hidden" id="customer-lat">
                    <input type="hidden" id="customer-lon">
                    <h3 style="margin-top: 1.5rem; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--light-border);">Customer Information</h3>
                    <div class="form-grid">
                        <div class="input-group">
                            <input type="text" id="customer-name" class="input-field" placeholder=" " required>
                            <label for="customer-name" class="input-label">Customer Name</label>
                        </div>
                        <div class="input-group">
                            <input type="tel" id="customer-mobile" class="input-field" placeholder=" " pattern="[0-9]{10}" title="10-digit mobile number" required>
                            <label for="customer-mobile" class="input-label">Mobile Number</label>
                        </div>
                        <div class="input-group grid-col-span-2">
                            <textarea id="customer-address" rows="2" class="input-field" placeholder=" " required></textarea>
                            <label for="customer-address" class="input-label">Customer Address</label>
                        </div>
                        <div class="input-group grid-col-span-2">
                            <button type="button" id="get-location-btn" class="btn-secondary" style="width: 100%;">
                                <span class="material-symbols-outlined">pin_drop</span>
                                Set Customer Location on Map
                            </button>
                        </div>
                        <div class="input-group grid-col-span-2">
                            <input type="date" id="due-date" class="input-field" placeholder=" " required>
                            <label for="due-date" class="input-label">Due Date</label>
                        </div>
                    </div>
                    
                    <h3 style="margin-top: 2.5rem; margin-bottom: 1rem;">Window Details</h3>
                    <div id="glass-options-container" class="glass-options">
                        <div class="checkbox-group">
                            <input type="checkbox" id="same-glass-all" style="width: 1.15em; height: 1.15em;">
                            <label for="same-glass-all">Same glass for all windows</label>
                        </div>
                        <div id="global-glass-name-container" style="display: none;">
                            <div class="input-group">
                                <input type="text" id="global-glass-name" class="input-field" placeholder=" ">
                                <label for="global-glass-name" class="input-label">Glass Name</label>
                            </div>
                        </div>
                    </div>

                    <div id="windows-container"></div>
                    
                    <button type="button" id="add-window-btn" class="btn-secondary" style="width: 100%; margin: 1rem 0;">
                        <span class="material-symbols-outlined">add</span>
                        Add Another Window
                    </button>
                    
                    <div style="display: flex; justify-content: flex-end; margin-top: 2rem; border-top: 1px solid var(--light-border); padding-top: 2rem;">
                        <button type="submit" id="save-order-btn" class="btn-success">
                            <span class="material-symbols-outlined">save</span>
                            Save Order
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- All required modals for this page -->
    <div id="message-modal" class="modal"><div class="modal-content"><p id="message-text" class="modal-message"></p><button id="message-ok-btn" class="btn-primary" style="min-width: 120px;">OK</button></div></div>
    <div id="loading-overlay" class="loading-overlay"><div class="spinner"></div></div>
    <div id="location-picker-modal" class="modal">
        <div class="modal-content" style="max-width: 800px; padding: 0;">
            <div style="padding: 1.5rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--light-border);">
                <h3>Select Customer Location</h3>
                <button id="location-picker-close-btn" class="remove-window-btn" style="position: static; border-radius: 50%;"><span class="material-symbols-outlined">close</span></button>
            </div>
            <div id="map-container" style="height: 400px; width: 100%; position: relative;"><div class="map-pin"></div></div>
            <div style="padding: 1.5rem; display: flex; justify-content: flex-end; gap: 1rem; border-top: 1px solid var(--light-border);">
                <button id="cancel-location-btn" class="btn-secondary">Cancel</button>
                <button id="confirm-location-btn" class="btn-primary">Confirm Location</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, getDoc, updateDoc, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        (function() {
            // --- All JS from the original file is included here, with modifications for MPA ---
            // The full JS block is too large to repeat here, but the following "main" block is added at the end
            // of the original script to control this specific page's logic.

            // --- PAGE-SPECIFIC INITIALIZATION LOGIC ---
            document.addEventListener('DOMContentLoaded', () => {
                const urlParams = new URLSearchParams(window.location.search);
                const orderId = urlParams.get('id');
                
                if (orderId) {
                    // EDIT MODE
                    loadOrderForEditing(orderId);
                } else {
                    // CREATE MODE
                    setupFormForCreate();
                }
            });

            async function loadOrderForEditing(orderId) {
                showLoading();
                try {
                    const orderRef = doc(db, 'upvc_orders', orderId);
                    const orderSnap = await getDoc(orderRef);
                    if (orderSnap.exists()) {
                        setupFormForEdit({ id: orderSnap.id, ...orderSnap.data() });
                    } else {
                        showMessageModal("Order not found. Redirecting...");
                        setTimeout(() => window.location.href = 'view-orders.html', 2000);
                    }
                } catch (error) {
                    console.error("Error loading order for edit: ", error);
                    showMessageModal("Failed to load order data.");
                } finally {
                    hideLoading();
                }
            }

            // In handleFormSubmit function, change the end of the 'try' block:
            // Original: showOrderDetails(finalOrderId);
            // New:
            showMessageModal(`Order successfully ${isUpdating ? 'updated' : 'saved'}!`);
            window.location.href = `order-details.html?id=${finalOrderId}`;
        })();
    </script>
</body>
</html>
